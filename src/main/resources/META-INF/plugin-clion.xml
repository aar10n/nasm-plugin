<!-- CLion-specific extensions for NASM plugin -->
<idea-plugin>
    <!-- Dependencies for CLion-specific features -->
    <depends>com.intellij.cidr.lang</depends>

    <extensions defaultExtensionNs="com.intellij">
        <!-- Cross-language navigation: NASM extern symbols -> C/C++ declarations -->
        <!-- Registered as "first" to take priority for extern symbols -->
        <gotoDeclarationHandler
                implementation="dev.agb.nasmplugin.clion.NasmToCppGotoHandler"
                order="first"/>

        <!-- Cross-language navigation: C/C++ extern declarations -> NASM labels -->
        <!-- Allows navigation from C/C++ to NASM assembly implementations -->
        <gotoDeclarationHandler
                implementation="dev.agb.nasmplugin.clion.CppToNasmGotoHandler"
                order="first"/>

        <!-- Enable bidirectional "Find Usages" between NASM and C/C++ -->
        <!-- When searching for C/C++ symbol usages, this finds NASM extern references -->
        <referencesSearch
                implementation="dev.agb.nasmplugin.clion.NasmToCppReferencesSearchExecutor"/>

        <!-- When searching for NASM label usages, this finds C/C++ extern references -->
        <referencesSearch
                implementation="dev.agb.nasmplugin.clion.CppToNasmReferencesSearchExecutor"/>
    </extensions>

    <!-- CIDR Debugger Integration -->
    <extensions defaultExtensionNs="cidr.debugger">
        <!-- Register NASM as a debuggable language with CLion's native debugger -->
        <!-- This allows breakpoints in NASM assembly files to work with GDB/LLDB -->
        <languageSupport language="NASM" implementationClass="dev.agb.nasmplugin.clion.NasmDebuggerLanguageSupport"/>

        <!-- Register NASM file type as supporting line breakpoints -->
        <lineBreakpointFileTypesProvider implementation="dev.agb.nasmplugin.clion.NasmLineBreakpointFileTypesProvider"/>
    </extensions>

    <!-- Project Model Integration -->
    <extensions defaultExtensionNs="com.intellij">
        <!-- Project model-based include path resolver (overrides fallback resolver) -->
        <projectService
                serviceInterface="dev.agb.nasmplugin.navigation.NasmIncludePathResolver"
                serviceImplementation="dev.agb.nasmplugin.clion.projectmodel.ProjectModelIncludePathResolver"
                overrides="true"/>
    </extensions>

    <!-- Project Listeners -->
    <projectListeners>
        <!-- Listen for CLion workspace changes (e.g., "Reload CMake/Makefile Project") -->
        <listener
                class="dev.agb.nasmplugin.clion.projectmodel.NasmWorkspaceListener"
                topic="com.jetbrains.cidr.project.workspace.CidrWorkspaceListener"/>

        <!-- Listen for instantaneous workspace state changes to trigger re-analysis -->
        <listener
                class="dev.agb.nasmplugin.clion.projectmodel.CidrWorkspaceInstantaneousListener"
                topic="com.jetbrains.cidr.project.workspace.CidrWorkspaceInstantaneousStateChangeListener"/>
    </projectListeners>

    <!-- Actions -->
    <actions>
        <!-- Show Compiler Info action -->
        <action id="NASM.ShowCompilerInfo"
                class="dev.agb.nasmplugin.clion.ShowNasmCompilerInfoAction"
                text="Show Compiler Info"
                description="Show compilation information for this NASM file"
                icon="AllIcons.Actions.Properties">
            <add-to-group group-id="EditorPopupMenu" anchor="last"/>
        </action>

        <!-- Reload NASM Project Model action -->
        <action id="NASM.ReloadProjectModel"
                class="dev.agb.nasmplugin.clion.ReloadNasmProjectModelAction"
                text="Reload NASM Project Model"
                description="Re-analyze NASM compilation information from build system"
                icon="AllIcons.Actions.Refresh">
            <add-to-group group-id="ToolsMenu" anchor="last"/>
        </action>
    </actions>
</idea-plugin>
